<!doctype html>
<html>

<head>
    <title>Speech Recognition Models</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet"> -->
    <script src="hark.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha512-v8ng/uGxkge3d1IJuEo6dJP8JViyvms0cly9pnbfRxT6/31c3dRWxIiwGnMSWwZjHKOuY3EVmijs7k1jz/9bLA==" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="platform.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io-stream/0.9.1/socket.io-stream.js" integrity="sha512-CIsFvh6QCVJHM5XSBQFm7a3mCErndwx9AugcP+nf/YxUQVVWY14klqk+3IG/qNqDpHg5pYVcZWiMt9SeZTiQnw==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        
        .icon-container {
            position: absolute;
            right: 20px;
            top: calc(10% - 10px);
        }
        
        .output-loader {
            position: relative;
            height: 20px;
            width: 20px;
            display: inline-block;
            animation: around 5.4s infinite;
        }
        
        @keyframes around {
            0% {
                transform: rotate(0deg)
            }
            100% {
                transform: rotate(360deg)
            }
        }
        
        .output-loader::after,
        .output-loader::before {
            content: "";
            background: white;
            position: absolute;
            display: inline-block;
            width: 100%;
            height: 100%;
            border-width: 2px;
            border-color: #333 #333 transparent transparent;
            border-style: solid;
            border-radius: 20px;
            box-sizing: border-box;
            top: 0;
            left: 0;
            animation: around 0.7s ease-in-out infinite;
        }
        
        .output-loader::after {
            animation: around 0.7s ease-in-out 0.1s infinite;
            background: transparent;
        }
        
        .disclaimer {
            font-size: 14px;
        }
        
         :required {
            background: #00b300;
        }
        
        div.stars {
            width: 270px;
            display: inline-block;
        }
        
        input.star {
            display: none;
        }
        
        label.star {
            float: right;
            padding: 10px;
            font-size: 35px;
            color: #444;
            transition: all .2s;
        }
        
        input.star:checked~label.star:before {
            content: '\f005';
            color: #00b300;
            transition: all .25s;
        }
        
        input.star-5:checked~label.star:before {
            color: #00b300;
            text-shadow: 0 0 20px #952;
        }
        
        input.star-1:checked~label.star:before {
            color: #F62;
        }
        
        label.star:hover {
            transform: rotate(-15deg) scale(1.3);
        }
        
        label.star:before {
            content: '\f006';
            font-family: FontAwesome;
        }
        
         ::-webkit-input-placeholder {
            /* Chrome/Opera/Safari */
            text-align: center;
        }
        
         ::-moz-placeholder {
            text-align: center;
        }
        
         ::-ms-placeholder {
            text-align: center;
        }
        
        #mic_image:hover {
            border-radius: 70%;
            box-shadow: 0 0 14px 8px rgba(33, 33, 33, .2);
        }
        
        .row {
            padding: 15px;
            margin: 15px;
            border: 1px black solid;
        }
        
        #like,
        #dislike {
            display: inline-block;
            cursor: pointer;
            margin: 10px;
        }
        
        #dislike:hover,
        #like:hover {
            color: #2EBDD1;
            transition: all .2s ease-in-out;
            transform: scale(1.1);
        }
        
        .active {
            color: #2EBDD1;
        }
        
        #status_text {
            margin-top: 10px;
        }
        
        #loader {
            margin-top: 20px;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 2s linear infinite;
            /* Safari */
            animation: spin 2s linear infinite;
        }
        
        #file-loader {
            margin-top: 20px;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 2s linear infinite;
            /* Safari */
            animation: spin 2s linear infinite;
        }
        /* Safari */
        
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <center>
        <div class="container">
            <div class="row" style="border: 0px;">
                <div class="col-sm-12">
                    <center>
                        <h4 id="title-text">Speech Recognition Models</h4>
                        <br />
                        <h6 id="userid"></h6>
                    </center>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <br />
                    <div style="min-height:100px;min-width:100px;">
                        <center>
                            <img src="mic.png" id="mic_image" onclick="onMicClick()" height="100" width="100" alt="MIC" /><br />
                            <p id="status_text" style="display: none;">Starting</p>
                        </center>
                    </div>
                </div>
                <div class="col-sm-12">
                    <br />
                </div>
                <div class="col-sm-12 col-md-12">
                    <center>
                        <audio controls id="audio_sample_id" style="display: none;">
                            <source src="" id="sample_id" />
                        </audio>
                    </center>
                </div>
                <div class="col-sm-12">
                    <div class="outputcontainer">
                        <textarea id="output" placeholder="Output" rows="6" readonly></textarea>
                        <button class="btn btn-primary" id="translate" onclick="callTranslateAPI()" style="display:none;">Translate</button>
                        <button class="btn btn-primary" id="translatingBtn" type="button" disabled style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Translating...</span>
                        </button>
                        <textarea id="translated_text" placeholder="Translation" rows=6 readonly style="display:none;margin-top:0.7%;"></textarea>
                        <div class="icon-container" id='output-loader-icon' style='display: none;'>
                            <i class="output-loader"></i>
                        </div>
                    </div>
                    <br />
                    <p class="disclaimer"><strong>Disclaimer :</strong> Transcription is best if you directly speak into the microphone and the performance might not be the same if you use it over a conference call.
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="custom-file mb-3">
                        <p class="disclaimer"><strong>Note :</strong> Transcription would be finer if you have a video file with less audio disturbance.</p>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="url" placeholder="Please paste your url here...">
                            <label for="url">Paste your URL here...</label>
                        </div>
                        <button class="btn btn-secondary" id="clearBtn" onclick="clearUrl()">Clear</button>
                        <button class="btn btn-primary" id="submitBtn" onclick="submitUrl()">Submit</button>
                        <button class="btn btn-primary" id="processBtn" type="button" disabled style="display: none;">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Processing...</span>
                        </button>
                    </div>
                    <br/>
                    <center>
                        <div id="file-loader" style='display: none;'></div>
                    </center>
                </div>
            </div>
        </div>
    </center>

    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            init variables
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
        let socket, socket_close_timeout = null,
            fileSocket, micSocketIO, fileSocketIO;
        let current_lang = 'en-IN',
            selected_lang = 'en-IN';
        let bufferSize = 16384;
        let sentOnce = true;
        let state = "OFF";
        let speechEvents = null;
        let input, processor, context, globalStream, audioContextClass;
        let localBuffer = null,
            isSpeaking = false;
        let timeout_ = null,
            state_end = false,
            audioData = [],
            recordingLength = 0,
            defaultSampleRate = 48000,
            socket_disconnect_timeout = null;
        let userId = null,
            recordedBlob = null,
            rating = null,
            feedback = null,
            device = null,
            browser = null,
            transcription_text = null,
            transcription_language = null,
            end_timeout = null;
        let nAgt = navigator.userAgent,
            verOffset;
    </script>
    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            utilities
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
        function fetchCurrentLanguageCode(language) {
            language = language.toLowerCase();
            // if (language === "kannada") {
            //     return "kn";
            // } else
            if (language === "indian-english") {
                return "en-IN";
            } else if (language === "indian-english-bio") {
                return "en-IN-BIO";
            } else if (language === "hindi") {
                return "hi";
            } else if (language === "tamil") {
                return "ta";
            } else if (language === "bengali") {
                return "bn";
            } else if (language === "nepali") {
                return "ne";
            } else if (language === "kannada") {
                return "kn";
            } else if (language === "gujarati") {
                return "gu";
            }
            // else if (language === "telugu") {
            //     return "te";
            // } else if (language === "gujarati") {
            //     return "gu";
            // } else if (language === "kannada-lm") {
            //     return "kn-lm";
            // } else if (language === "odia") {
            //     return "or";
            // }
            else {
                return "en-IN";
            }
        }

        function toCamelCase(word) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        }

        function getDeviceInfo() {
            const os = platform.os;
            let info = os.family + " " + os.version;
            if (platform.product) {
                info = info + " " + platform.product;
            }
            return info;
        }

        function getBrowserInfo() {
            let info = platform.name + " " + platform.version;
            return info;
        }


        function timeout(timeLimit, funcToCall) {
            let timeout = setTimeout(function() {
                funcToCall()
            }, timeLimit);
            return timeout;
        }

        function disableAutoMicClose() {
            if (timeout_ !== null) {
                clearTimeout(timeout_)
                timeout_ = null;
            }
        }

        function enableAutoMicClose(callbackFunction) {
            timeout_ = timeout(120000, callbackFunction);
        }

        function enableDelaySocketClose() {
            end_timeout = setTimeout(() => {
                endSocket();
                end_timeout = null;
            }, 4000);
        }

        function disableDelaySocketClose() {
            if (end_timeout !== null || end_timeout) {
                clearTimeout(end_timeout);
                end_timeout = null;
                endSocket();
            }
        }

        function enableSocketClose() {
            if (socket_close_timeout === null) {
                socket_close_timeout = setTimeout(() => {
                    if (state === "OFF")
                        endSocket();
                    socket_close_timeout = null;
                }, 60000);
            }
        }

        function validURL(str) {
            var pattern = new RegExp('^(https?:\\/\\/)?' + // protocol
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // domain name
                '((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // port and path
                '(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
                '(\\#[-a-z\\d_]*)?$', 'i'); // fragment locator
            return !!pattern.test(str);
        }

        function callTranslateAPI() {
            const sourceText = document.getElementById('output').value;
            const translateBtn = document.getElementById('translate');
            const translatingBtn = document.getElementById('translatingBtn');
            translatingBtn.style.display = "block";
            translateBtn.style.display = "none";
            var requestBody = {
                paragraphs: [{
                    src: sourceText,
                    s_id: 'ab-15-de-43-e-gss3-aa'
                }],
                workflowCode: "WF_S_STKTR",
                source_language_code: current_lang,
                target_language_code: 'en',
                model_id: current_lang === "hi" ? '100' : '66',
                locale: current_lang
            };
            const authToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyTmFtZSI6InJvc2hhbi5zaGFoQHRhcmVudG8uY29tIiwiV2VsY29tZUAxMjMiOiJiJyQyYiQxMiR1ZUJEVFhVMWhTNDNMR0dxNW5HY0UuZTN5UjR3Zm1sd1JCelhVTjcucTN3dzdVRlFiZGY2RyciLCJleHAiOjE2Mjg2NjM4Nzh9.53FXyI_n-7G93vs43bdw2rvMT-FdjwstnyFu8wWOxJI"
            const endPoint = `https://auth.anuvaad.org/anuvaad-etl/wf-manager/v1/workflow/sync/initiate`;
            fetch(endPoint, {
                headers: {
                    "auth-token": `${authToken}`,
                    "content-type": "application/json",
                },
                body: `${JSON.stringify(requestBody)}`,
                method: "POST",
            }).then(async(response) => {
                let data = await response.json();
                translateBtn.style.display = "block";
                translatingBtn.style.display = "none";
                if (response.ok) {
                    const translated_text = document.getElementById("translated_text");
                    translated_text.textContent = data['output']['translations'].map(text => text.tgt).join(' ');
                    translated_text.style.display = "block";
                }
            }).catch(err => {
                translateBtn.style.display = "block";
                translatingBtn.style.display = "none";
            });

        }

        function clearUrl() {
            const urlText = document.getElementById('url');
            urlText.value = ""
        }

        function submitUrl() {
            const submitBtn = document.getElementById('submitBtn');
            const processBtn = document.getElementById('processBtn');
            const urlText = document.getElementById('url');
            if (validURL(urlText.value)) {
                submitBtn.style.display = "none";
                processBtn.style.display = "inline";
                const endpoint = "http://54.213.245.181:5001/generate_srt"
                const requestBody = {
                    url: urlText.value,
                    language: current_lang
                }
                fetch(endpoint, {
                        method: 'post',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(requestBody)
                    })
                    .then(async res => {
                        try {
                            submitBtn.style.display = "inline";
                            processBtn.style.display = "none";
                            let rsp_data = await res.json();
                            console.log(rsp_data)
                            if (res.ok) {
                                getSrtAPICall(rsp_data.filename);
                            } else {
                                console.log('failed...')
                            }
                        } catch (error) {
                            console.log(error)
                        }
                    })
                    .catch(err => {
                        submitBtn.style.display = "inline";
                        processBtn.style.display = "none";
                        console.log('error occurred')
                    })
            } else {
                alert('Please enter a valid URL..')
            }
        }

        const getSrtAPICall = (filename) => {
            const endPoint = `http://54.213.245.181:5001/get_srt/${filename}`;
            fetch(endPoint, {
                    method: 'get',
                })
                .then(async res => {
                    let rsp_data = await res.blob();
                    const url = URL.createObjectURL(rsp_data);
                    let a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                })
                .catch(error => console.log(error))
        }

        // function disableSocketClose() {
        //     if (socket_close_timeout !== null) {
        //         clearTimeout(socket_close_timeout);
        //         socket_close_timeout = null;
        //     }
        // }
    </script>
    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            audio manipulation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
        function downSampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate == sampleRate) {
                return buffer;
            }
            if (outSampleRate > sampleRate) {
                throw "down-sampling rate show be smaller than original sample rate";
            }
            var sampleRateRatio = sampleRate / outSampleRate;
            var newLength = Math.round(buffer.length / sampleRateRatio);
            var result = new Int16Array(newLength);
            var offsetResult = 0;
            var offsetBuffer = 0;
            while (offsetResult < result.length) {
                var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                var accum = 0,
                    count = 0;
                for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }

                result[offsetResult] = Math.min(1, accum / count) * 0x7FFF;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result.buffer;
        }

        function appendBuffer(buffer1, buffer2) {
            const buffer = new ArrayBuffer(buffer1.byteLength + buffer2.byteLength);
            let tmp = new Uint8Array(buffer);
            tmp.set(new Uint8Array(buffer1), 0);
            tmp.set(new Uint8Array(buffer2), buffer1.byteLength);
            return buffer;
        };

        function flattenArray(channelBuffer, recordingLength) {
            let result = new Float32Array(recordingLength);
            let offset = 0;
            for (let i = 0; i < channelBuffer.length; i++) {
                let buffer = channelBuffer[i];
                result.set(buffer, offset);
                offset += buffer.length;
            }
            return result;
        }

        function writeUTFBytes(view, offset, string) {
            for (var i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function generateWavBlob(finalBuffer) {
            let buffer = new ArrayBuffer(44 + finalBuffer.length * 2);
            let view = new DataView(buffer);

            // RIFF chunk descriptor
            writeUTFBytes(view, 0, 'RIFF');
            view.setUint32(4, 44 + finalBuffer.length * 2, true);
            writeUTFBytes(view, 8, 'WAVE');
            // FMT sub-chunk
            writeUTFBytes(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // chunkSize
            view.setUint16(20, 1, true); // wFormatTag
            view.setUint16(22, 1, true); // wChannels:mono(1 channel) / stereo (2 channels)
            view.setUint32(24, defaultSampleRate, true); // dwSamplesPerSec
            view.setUint32(28, defaultSampleRate * 2, true); // dwAvgBytesPerSec
            view.setUint16(32, 4, true); // wBlockAlign
            view.setUint16(34, 16, true); // wBitsPerSample
            // data sub-chunk
            writeUTFBytes(view, 36, 'data');
            view.setUint32(40, finalBuffer.length * 2, true);

            // write the PCM samples
            let index = 44;
            let volume = 1;
            for (var i = 0; i < finalBuffer.length; i++) {
                view.setInt16(index, finalBuffer[i] * (0x7FFF * volume), true);
                index += 2;
            }

            // our final blob
            let blob = new Blob([view], {
                type: 'audio/wav'
            });
            return blob;
        }
    </script>
    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            UI interactions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
        function enableRating(flag) {
            let value = flag ? 'auto' : 'none'
                // let select_value = flag ? false : true
            if (!flag) {
                $('select').prop("disabled", true)
                $('#Submit').attr("disabled", true);
            }

            $('input.star').css({
                'pointer-events': value
            })
            $('label.star').css({
                'pointer-events': value
            })
            $('#like').css({
                'pointer-events': value
            })
            $('#dislike').css({
                'pointer-events': value
            })
            if (flag) {
                $('#rating-note').hide();
            } else {
                $('#rating-note').show();
            }
        }

        function connectFileSocket(methodToRun) {
            fileSocket = io({
                autoConnect: false,
                reconnection: false
            });
            fileSocket.connect();
            fileSocket.on('connect', function() {
                userId = fileSocket.id;
                fileSocket.emit('connect_file_stream');
            });
            fileSocket.on('connect-success', function(data) {
                console.log("connect-success", userId);
                methodToRun();
                document.getElementById('userid').innerHTML = "";
            });
            fileSocket.on("file_upload_response", function(transcription, language) {
                console.log("response received");
                document.getElementById("file_upload_response").innerHTML = transcription;
                // fileSocket.disconnect();
                $('#file-loader').hide();
            });
            fileSocket.on("disconnect", function() {
                console.log("File socket is disconnected");
            });
            fileSocket.on("error", (err) => {
                console.log("file error", err);
            })
        }

        function connectSocket(startMic) {
            socket = io('/', {
                autoConnect: false
            });
            socket.connect();
            socket.on('connect', function() {
                console.log('socket connected with client')
                userId = socket.id;
                socket.emit('connect_mic_stream');
            });
            socket.on('connect-success', function(data) {
                console.log("connect-success", userId);
                startMic();
                document.getElementById('userid').innerHTML = "";
            });
            socket.on('response', function(data, language) {
                if (language === "en-IN") data = data.toLowerCase();
                document.getElementById('output').value = data;
                transcription_text = data;
                transcription_language = language;
            });
            socket.on('disconnect', function() {
                console.log("disconnected");
            })
            socket.on('terminate', function() {
                if (socket_close_timeout === null) {
                    endSocket();
                    console.log("end socket called");
                }
            });

            socket.on('abort', function() {
                alert("The server is busy at the moment, please try after sometime.");
                // $(".rating **").attr("disabled", "disabled").off('click');
                enableRating(true);
                // stopRecording();
                document.getElementById('userid').innerHTML = "Server busy. Please try again after some time.";
            });
        }

        function uiOnMicStart() {
            const translateBtn = document.getElementById("translate");
            const translatedText = document.getElementById("translated_text");
            const output = document.getElementById('output');
            output.setAttribute("readonly", true);
            output.value = "";
            translateBtn.style.display = "none";
            translatedText.style.display = "none";
            let image = document.getElementById("mic_image");
            image.src = "stop.png";
            image.addEventListener('load', function() {
                $('#status_text').text("Start Speaking !");
            })
            $('.active').removeClass('active');
            enableRating(false);
            document.getElementById('output').value = "";
            $('#audio_sample_id').hide();
            try {
                document.getElementById("audio_sample_id").pause();
            } catch (err) {

            }
        }

        function uiOnMicStop() {
            if ((verOffset = nAgt.indexOf("Firefox")) != -1) {
                $('#mic_image').animate({
                    'top': '10%',
                    'left': '10%',
                    'right': '10%',
                    'bottom': '10%',
                    'height': '100px',
                    'width': '100px'
                });
            } else {
                $("#mic_image").animate({
                    zoom: '100%'
                });
            }
            // setTimeout(() => {
            let image = document.getElementById("mic_image");
            image.src = "mic.png";
            // }, 1000);
            $('#audio_sample_id').show();
            enableRating(true);
            punctuateText(transcription_text);
        }

        function stateOnMicStart() {
            state = "ON";
            selected_lang = current_lang;
            audioData = [];
            recordingLength = 0;
            enableAutoMicClose(stopRecording);
        }

        function stateOnMicStop() {
            state = "OFF";
            socket.emit('mic_data', null, current_lang, false, true);
        }
        let stream = null;
        async function onMicClick() {
            try {
                if (state === 'OFF') {
                    let constraints = {
                        audio: true,
                        video: false
                    }
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } else {
                    stream = null;
                }
                toggle();
            } catch (err) {
                alert("Please give mic permission to interact with the website");
                console.log(err);
            }
        }

        function toggle() {
            // disableDelaySocketClose();
            // if (socket && socket !== null) {
            //     if (socket.connected)
            //         endSocket();
            // }
            // let audio = new Audio("click_sound.wav ");
            $('input[type="radio"]').prop('checked', false);
            $('#feedback-dropdown option').prop('selected', function() {
                return this.defaultSelected;
            });
            if (state === "OFF") {
                if ((verOffset = nAgt.indexOf("Firefox")) != -1) {
                    $('#mic_image').animate({
                        'top': '10%',
                        'left': '10%',
                        'right': '10%',
                        'bottom': '10%',
                        'height': '87px',
                        'width': '87px'
                    }, "slow");
                } else {
                    $("#mic_image").animate({
                        zoom: '87%'
                    }, "slow");
                }
                // audio.play();
                if (socket && socket !== null && socket.connected) {
                    startRecording();
                } else {
                    connectSocket(startRecording);
                }
                $('#status_text').show();
                $('#status_text').text("Starting...");
            } else if (state === "ON") {
                stopRecording();
                // audio.play();
                $('#status_text').hide();
            }
        }

        function setSilenceDetector(audioStream, context) {
            let options = {
                audioContext: context
            };
            speechEvents = hark(audioStream, options);

            speechEvents.on('speaking', function() {
                isSpeaking = true;
                // console.log('speaking');
            });

            speechEvents.on('stopped_speaking', function() {
                // console.log('stopped_speaking');
                isSpeaking = false;
            });
        }

        function streamAudioProcess(e) {
            audioData.push(new Float32Array(e.inputBuffer.getChannelData(0)));
            recordingLength += bufferSize;
            if (state === "ON") {
                state_end = false;
                var data_44100 = e.inputBuffer.getChannelData(0);
                // let data_16000 = data_44100;
                var data_16000 = downSampleBuffer(data_44100, defaultSampleRate, 16000);
                if (isSpeaking) {
                    sentOnce = false;

                    if (localBuffer !== undefined && localBuffer !== null) {
                        data_16000 = appendBuffer(localBuffer, data_16000)
                    }
                    // console.log("emitted", data_16000);
                    socket.emit('mic_data', data_16000, current_lang, true, false);
                    localBuffer = null;
                } else {
                    if (!sentOnce) {
                        sentOnce = true;
                        socket.emit('mic_data', data_16000, current_lang, false, false);
                        // console.log("emitted last");
                    } else {
                        localBuffer = data_16000;
                    }
                }
            } else {
                if (!state_end) {
                    var data_44100 = e.inputBuffer.getChannelData(0);
                    var data_16000 = downSampleBuffer(data_44100, defaultSampleRate, 16000);
                    // let data_16000 = data_44100;
                    state_end = true;
                    socket.emit('mic_data', data_16000, current_lang, false, true);
                    console.log("emitted last");
                }
            }
        };

        function startRecording() {
            uiOnMicStart();
            stateOnMicStart();
            enableSocketClose();
            let sendData = false;

            // navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
            audioContextClass = window.AudioContext || window.webkitAudioContext;

            context = new audioContextClass({
                latencyHint: 'interactive',
            });

            defaultSampleRate = context.sampleRate;

            setSilenceDetector(stream.clone(), context);

            input = context.createMediaStreamSource(stream);
            processor = context.createScriptProcessor(bufferSize, 1, 1);

            input.connect(processor);
            processor.connect(context.destination);

            processor.onaudioprocess = streamAudioProcess;
            // }).catch(function (err) {
            //     console.log(err);
            //     stopRecording();
            // });
        }

        function endSocket() {
            socket.disconnect();
        }

        function stopRecording() {
            disableAutoMicClose();
            uiOnMicStop();
            stateOnMicStop();
            stopMediaRecorder();
            // enableDelaySocketClose();
        }

        function stopMediaRecorder() {
            if (speechEvents && speechEvents !== null)
                speechEvents.stop();
            if (input && input !== null)
                input.disconnect();
            if (processor && processor !== null)
                processor.disconnect();

            let finalBuffer = flattenArray(audioData, recordingLength);
            let blob = generateWavBlob(finalBuffer);
            if (blob == null) {
                console.log("no blob generated");
                return;
            }
            recordedBlob = blob;
            let url = window.URL.createObjectURL(blob);
            document.getElementById("sample_id").src = url;
            document.getElementById("audio_sample_id").load();
        }

        function startFileUpload() {
            // $('#file-loader').show();
            // connectFileSocket(readFile);
            uploadFileToBatchService();
        }

        function updateLabel() {
            $('#file-error').hide();
            let file = document.querySelector('#audio_file_input').files[0];
            if (!file) {
                $('#run-model-btn').prop('disabled', true);
                document.getElementById('file_upload_label').innerHTML = "";
                $('#audio').hide();
                return;
            }
            let chosenFile = document.getElementById('audio_file_input').value;
            let theSplit = chosenFile.split('\\');
            chosenFile = theSplit[theSplit.length - 1];
            document.getElementById('file_upload_label').innerHTML = chosenFile;
            // if (file.size > 3500000) {
            //     $('#file-error').show();
            //     $('#run-model-btn').prop('disabled', true);
            //     return;
            // }
            // let fileNameSplit = file.name.split(".");
            // if()
            console.log(file);
            let URL_OBJECT = window.URL || window.webkitURL;
            let url = URL_OBJECT.createObjectURL(file);
            document.getElementById("audio_source").src = url;
            document.getElementById("audio").load();
            $('#audio').show();
            $('#run-model-btn').prop('disabled', false);
        }

        function readFile() {
            let files = document.querySelector('#audio_file_input').files;
            let blob = files[0];
            read_as_chunks_direct(blob);
        }

        function read_as_chunks_direct(file) {
            let stream = ss.createStream();
            ss(fileSocket).emit('file_data', stream, {
                name: file.name,
                size: file.size,
                language: current_lang
            });
            ss.createBlobReadStream(file, {
                highWaterMark: 3500000,
            }).pipe(stream)
        }

        function read_as_chunks(file) {
            let chunk_size = 3500000;
            let offset = 0;
            let size = file.size;
            let i = 0;
            if (size < chunk_size) {
                chunk_size = size;
            }
            while (i < size) {
                let end_size = offset + chunk_size
                if (size < end_size) {
                    end_size = size
                }
                let blob = file.slice(offset, end_size);
                let reader = new FileReader();
                reader.addEventListener('load', function(e) {
                    let chunk = e.target.result;
                    console.log("emitted file", chunk);
                    let inpStream = ss.createStream({
                        highWaterMark: 3500000
                    });
                    ss(fileSocket).emit('file_data', inpStream, current_lang, file.name);
                    ss.createBlobReadStream(chunk).pipe(inpStream);
                });
                reader.readAsArrayBuffer(blob);
                offset += chunk_size;
                i += chunk_size;
                console.log("read");
            }
        }
    </script>
    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Store to db related code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */

        function saveRating(bodyParams, enableRating) {
            const {
                recordedBlob,
                rating,
                feedback,
                device,
                browser,
                transcription_text,
                transcription_language,
                userId
            } = bodyParams;
            const formData = new FormData();
            formData.append('audio_data', recordedBlob);
            formData.append('rating', rating);
            formData.append('feedback', feedback);
            formData.append('device', device);
            formData.append('browser', browser);
            formData.append('text', transcription_text);
            formData.append('language', transcription_language);
            formData.append('user_id', userId);

            $.ajax({
                type: 'POST',
                url: 'api/feedback',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function() {
                    $("#loader").show();
                },
                success: function(data, textStatus, jqXHR) {
                    $("#loader").hide();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $("#loader").hide();
                    alert("Rating update failed, Please try again")
                    enableRating(true)
                    $('#Submit').attr("disabled", false);
                }
            });
        }

        function uploadFileToBatchService() {
            let files = document.querySelector('#audio_file_input').files;
            let blob = files[0];
            //let language = 'hi';
            let formData = new FormData();
            formData.append("audio_data", blob);
            formData.append("language", current_lang);
            formData.append("user", "");
            let filename = blob.name;
            $.ajax({
                type: 'POST',
                url: '/batch-service',
                data: formData,
                contentType: false,
                processData: false,
                crossDomain: true,
                beforeSend: function() {
                    // Show image container
                    $('#file-loader').show();
                },
                success: function(response, textStatus, jqXHR) {
                    const resp = response["data"];
                    let a = document.createElement('a');
                    let bl = new Blob([resp["srt"]], {
                        'type': 'text/plain'
                    });
                    let url = window.URL.createObjectURL(bl);
                    a.href = url;
                    filename = filename.slice(0, filename.length - 4);
                    a.download = filename + '.srt';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    $('#file-loader').hide();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert('Failed: ' + textStatus);
                    $('#file-loader').hide();
                }

            });
        }

        function punctuateText(textToPunctuate) {
            let formData = new FormData();
            formData.append("text", textToPunctuate);
            formData.append("language", current_lang);
            $.ajax({
                type: 'POST',
                url: '/punctuate',
                data: formData,
                contentType: false,
                processData: false,
                crossDomain: true,
                beforeSend: function() {
                    // Show image container
                    $('#output-loader-icon').show();
                },
                success: function(response, textStatus, jqXHR) {
                    const resp = response["data"];
                    console.log(resp['text']);
                    $('#output-loader-icon').hide();
                    const output = document.getElementById('output')
                    output.value = resp["text"];
                    output.removeAttribute("readonly");
                    if (resp["text"]) {
                        const translateBtn = document.getElementById('translate');
                        translateBtn.style.display = "block";
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert('Failed: ' + textStatus);
                    $('#output-loader-icon').hide();
                }

            });
        }
    </script>
    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            on document loaded event
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */
        $(document).ready(function() {
            ss.forceBase64 = true;
            let pathname = window.location.pathname.replace("/", "");
            if (pathname.length != 0) {
                current_lang = fetchCurrentLanguageCode(pathname);
                let titleLanguage = toCamelCase(pathname);
                if (pathname === "indian-english")
                    titleLanguage = "English(IN)";
                else if (pathname === "kannada-lm")
                    titleLanguage = "Kannada (With LM)";
                document.getElementById("title-text").innerHTML = titleLanguage + " Speech Recognition Model"
            }

            device = getDeviceInfo();
            browser = getBrowserInfo();
            $('#Submit').on('click', function() {
                event.preventDefault();
                $('.active').removeClass('active');
                $(this).addClass('active');
                stopRecording();
                rating = $('[name="star"]:checked').val();
                feedback = $("#feedback-dropdown").val();
                enableRating(false)
                saveRating({
                    recordedBlob,
                    rating,
                    feedback,
                    device,
                    browser,
                    transcription_text,
                    transcription_language,
                    userId
                }, enableRating);
            });
            enableRating(false);
            $('input[type=radio][name=star]').change(function() {
                console.log($(this).val())
                if ($(this).val() >= 1) {
                    $('select').prop("disabled", false)
                    $('#Submit').attr("disabled", false)
                } else {
                    $('select').prop("disabled", true)
                    $('#Submit').attr("disabled", true)
                }
            });


        });
    </script>
</body>

</html>

</html>

</html>